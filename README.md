# two-factor-auth-learning
２要素認証学習用リポジトリです

# 2要素認証アプリ（SMS/メール認証型）設計書

## 1. プロジェクト概要

| 項目 | 内容 |
|-----|------|
| **目的** | 2要素認証の仕組みを学習する |
| **技術スタック** | Vue.js（フロントエンド）+ Rails（バックエンド） |
| **データストレージ** | メモリ（DBなし） |
| **対象者** | 学習用 |
| **認証方式** | SMS/メール認証型（時間制限付き承認） |

---

## 2. ユーザーインターフェース

### 2.1 ページレイアウト

1つのHTMLページに左右2つのエリアを配置

```
┌───────────────────────────────────────────────────────────┐
│                  2要素認証 学習アプリ                     │
├─────────────────────────┬─────────────────────────────────┤
│                         │                                 │
│   【ウィンドウ1】        │   【ウィンドウ2】               │
│   ログイン側             │   認証デバイス側                │
│   （50%の幅）            │   （50%の幅）                   │
│                         │                                 │
│ ┌─────────────────────┐ │ ┌─────────────────────────┐    │
│ │ ユーザー名:          │ │ │ [待機中...]             │    │
│ │ [          ]       │ │ │                         │    │
│ │                     │ │ │ ↓ ログイン試行検出      │    │
│ │ パスワード:          │ │ │                         │    │
│ │ [          ]       │ │ │ ┌───────────────────┐   │    │
│ │                     │ │ │ │ 🔐 ログイン試行   │   │    │
│ │ [ログイン]          │ │ │ │ を検出!           │   │    │
│ │                     │ │ │ │                   │   │    │
│ │ [待機中...]         │ │ │ │ xxxさんがログイン │   │    │
│ │                     │ │ │ │ を試みています    │   │    │
│ │                     │ │ │ │                   │   │    │
│ │ コード入力:          │ │ │ │ [承認] [拒否]    │   │    │
│ │ [          ]       │ │ │ │                   │   │    │
│ │ [送信]              │ │ │ └───────────────────┘   │    │
│ │                     │ │ │                         │    │
│ │ ✅ ログイン成功!     │ │ └─────────────────────────┘    │
│ │                     │ │                                 │
│ └─────────────────────┘ │                                 │
│                         │                                 │
└─────────────────────────┴─────────────────────────────────┘
```

### 2.2 ウィンドウ1（ログイン側）の画面遷移

1. **ログインフォーム**
   - ユーザー名入力フィールド
   - パスワード入力フィールド
   - 「ログイン」ボタン

2. **待機画面**
   - 「待機中...」メッセージ
   - 認証デバイスでの確認を促すテキスト

3. **コード入力画面**
   - コード入力フィールド
   - 「送信」ボタン

4. **成功画面**
   - ログイン成功のメッセージ
   - ウェルカムメッセージ

5. **失敗画面**
   - ログイン失敗のメッセージ
   - 「もう一度ログイン」ボタン

### 2.3 ウィンドウ2（認証デバイス側）の画面遷移

1. **待機画面**
   - 「待機中...」メッセージ
   - ログイン試行を監視中

2. **ログイン試行検出POP-UP**
   - ユーザー名表示
   - 「このデバイスですか？」というメッセージ
   - 「承認」「拒否」ボタン

3. **時間制限確認POP-UP**（5秒カウントダウン）
   - 「本当に承認しますか？」メッセージ
   - 残り時間表示
   - 進捗バー
   - 「YES!」「NO!」ボタン

4. **承認完了画面**
   - ✅ 承認完了メッセージ
   - コード表示（例：123456）
   - 「ログイン画面に入力してください」テキスト

5. **拒否完了画面**
   - ❌ 拒否完了メッセージ
   - ウィンドウ1に通知されることを伝えるテキスト

---

## 3. 認証フロー

### 3.1 フェーズ1：第1要素認証（知識 = パスワード）

**ユーザーアクション：**
1. ウィンドウ1でユーザー名を入力
2. ウィンドウ1でパスワードを入力
3. 「ログイン」ボタンをクリック

**Vue.js側：**
4. {username, password} をRails APIに送信
   - エンドポイント：`POST /api/login`

**Rails側：**
5. ユーザー情報をメモリから検索
6. パスワードと比較
7. パスワードが正しい場合：
   - `session_id` を生成（例：abc123xyz）
   - `verification_code` を生成（例：123456）
   - `code_expires_at` を設定（5分後）
   - `$login_attempts[session_id]` に追加
   - `status = "pending"`
8. APIレスポンス返却：`{success: true, session_id: "abc123xyz"}`

**Vue.js側：**
9. ログインフォームを非表示
10. 「待機中...」メッセージを表示
11. ウィンドウ1がポーリング開始
    - エンドポイント：`GET /api/login_attempts/:session_id/status`
    - 間隔：1秒ごと

### 3.2 フェーズ2：ウィンドウ2がログイン試行を検出

**Vue.js側（ウィンドウ2）：**
1. ポーリング開始（1秒ごと）
   - エンドポイント：`GET /api/login_attempts/pending`

**Rails側：**
2. `$login_attempts` から `status = "pending"` のものを検索
3. あれば、それをAPIレスポンスで返す

**Vue.js側：**
4. pending状態を検出
5. POP-UP表示

```
┌─────────────────────────────┐
│ 🔐 ログイン試行を検出!       │
├─────────────────────────────┤
│                             │
│ xxx さんがログインを         │
│ 試みています                │
│                             │
│ このデバイスですか?          │
│                             │
│ [承認] [拒否]              │
│                             │
└─────────────────────────────┘
```

### 3.3 フェーズ3：ユーザーが「承認」を選択

**ユーザーアクション：**
1. 「承認」ボタンをクリック

**Vue.js側：**
2. 時間制限 POP-UP を表示

```
┌─────────────────────────────┐
│  ⏰ 急いで!                  │
├─────────────────────────────┤
│                             │
│  本当に承認しますか?          │
│  5秒以内に決めてください!    │
│                             │
│  残り時間: ⏱️ 5秒             │
│  [████████████████] 進捗バー │
│                             │
│  [YES!] [NO!]              │
│                             │
└─────────────────────────────┘
```

3. 5秒のカウントダウン開始

**ユーザーの選択肢：**
- パターンA：「YES!」をクリック → フェーズ4Aへ
- パターンB：「NO!」をクリック → フェーズ4Bへ
- パターンC：5秒経過（タイムアウト） → フェーズ4Bへ

### 3.4 フェーズ4A：「YES!」が選ばれた場合

**Vue.js側（ウィンドウ2）：**
1. Rails APIに送信
   - エンドポイント：`PATCH /api/login_attempts/:session_id`
   - リクエスト：`{action: "approve"}`

**Rails側：**
2. `$login_attempts[session_id][:status] = "approved"` に更新
3. APIレスポンス返却

**Vue.js側（ウィンドウ2）：**
4. POP-UP閉じる
5. コード情報を表示

```
┌─────────────────────────────┐
│ ✅ 承認しました              │
├─────────────────────────────┤
│                             │
│ コード: 123456               │
│ ログイン画面に入力してください │
│                             │
└─────────────────────────────┘
```

**Vue.js側（ウィンドウ1）：**
6. ポーリングで "approved" を検出
7. 「待機中...」を非表示
8. コード入力フォームを表示

```
┌─────────────────────────────┐
│ 認証コードを入力してください │
├─────────────────────────────┤
│                             │
│ コード: [          ]        │
│ [送信]                     │
│                             │
└─────────────────────────────┘
```

**ユーザーアクション：**
9. ウィンドウ2に表示されたコード「123456」を確認
10. ウィンドウ1のフォームに入力
11. 「送信」ボタンをクリック

**Vue.js側（ウィンドウ1）：**
12. Rails APIに送信
    - エンドポイント：`POST /api/login_attempts/:session_id/verify`
    - リクエスト：`{verification_code: "123456"}`

**Rails側：**
13. `$login_attempts[session_id][:verification_code]` と比較
14. 一致したら：
    - `$login_attempts[session_id][:status] = "verified"` に更新
    - APIレスポンス：`{success: true}`

**Vue.js側（ウィンドウ1）：**
15. success = true なら、ログイン成功画面を表示

```
┌─────────────────────────────┐
│ ✅ ログイン成功!             │
├─────────────────────────────┤
│                             │
│ xxx さん、ようこそ          │
│                             │
│ 2要素認証によるログインが    │
│ 完了しました                │
│                             │
│ [ダッシュボードへ]          │
│                             │
└─────────────────────────────┘
```

### 3.5 フェーズ4B：「NO!」またはタイムアウト

**Vue.js側（ウィンドウ2）：**
1. 「NO!」をクリック または 5秒経過

**Rails側：**
2. `$login_attempts[session_id][:status] = "rejected"` に更新

**Vue.js側（ウィンドウ2）：**
3. 拒否メッセージを表示

```
┌─────────────────────────────┐
│ ❌ ログイン試行を拒否しました│
├─────────────────────────────┤
│                             │
│ ウィンドウ1に通知されます    │
│                             │
└─────────────────────────────┘
```

**Vue.js側（ウィンドウ1）：**
4. ポーリングで "rejected" を検出
5. ログイン失敗画面を表示

```
┌─────────────────────────────┐
│ ❌ ログインが拒否されました  │
├─────────────────────────────┤
│                             │
│ 認証デバイスでログインが     │
│ 拒否されました              │
│                             │
│ [もう一度ログイン]          │
│                             │
└─────────────────────────────┘
```

6. 最初のログインフォームに戻す

---

## 4. メモリ内のデータ構造

### 4.1 ユーザー情報

```ruby
$users = {
  1 => {
    id: 1,
    username: "Taro",
    password_hash: "hash1"
  },
  2 => {
    id: 2,
    username: "Hanako",
    password_hash: "hash2"
  }
}
```

### 4.2 ログイン試行情報

```ruby
$login_attempts = {
  "abc123xyz" => {
    user_id: 1,
    username: "Taro",
    verification_code: "123456",
    code_expires_at: 2025-10-25 16:05,
    status: "pending",
    created_at: 2025-10-25 16:00
  },
  "def456abc" => {
    user_id: 2,
    username: "Hanako",
    verification_code: "654321",
    code_expires_at: 2025-10-25 16:07,
    status: "approved",
    created_at: 2025-10-25 16:02
  }
}
```

### 4.3 statusの状態遷移

```
┌──────────┐
│ pending  │ ← ログイン試行開始時のステータス
└─────┬────┘
      │
      ├─→ ┌──────────┐
      │    │ approved │ ← ユーザーが「承認」をクリック
      │    └─────┬────┘
      │          │
      │          ├─→ ┌──────────┐
      │          │    │ verified │ ← コード検証成功（ログイン完了）
      │          │    └──────────┘
      │          │
      │          └─→ （コード検証失敗時は approved のまま）
      │
      └─→ ┌──────────┐
           │ rejected │ ← ユーザーが「拒否」をクリック or タイムアウト
           └──────────┘
```

---

## 5. APIエンドポイント一覧

### 5.1 ログインAPI

**エンドポイント：** `POST /api/login`

**リクエスト：**
```json
{
  "username": "Taro",
  "password": "password123"
}
```

**レスポンス（成功）：**
```json
{
  "success": true,
  "session_id": "abc123xyz"
}
```

**レスポンス（失敗）：**
```json
{
  "success": false,
  "error": "ユーザー名またはパスワードが正しくありません"
}
```

---

### 5.2 ログイン試行一覧取得API

**エンドポイント：** `GET /api/login_attempts/pending`

**リクエスト：** なし

**レスポンス：**
```json
{
  "login_attempts": [
    {
      "session_id": "abc123xyz",
      "username": "Taro"
    }
  ]
}
```

---

### 5.3 ログイン試行ステータス取得API

**エンドポイント：** `GET /api/login_attempts/:session_id/status`

**リクエスト：** なし

**レスポンス：**
```json
{
  "status": "pending"
}
```

**ステータスの値：**
- `"pending"` - 承認待ち
- `"approved"` - 承認済み
- `"rejected"` - 拒否済み
- `"verified"` - 検証完了（ログイン成功）

---

### 5.4 ログイン試行更新API

**エンドポイント：** `PATCH /api/login_attempts/:session_id`

**リクエスト：**
```json
{
  "action": "approve"
}
```

または

```json
{
  "action": "reject"
}
```

**レスポンス：**
```json
{
  "success": true,
  "status": "approved"
}
```

---

### 5.5 コード検証API

**エンドポイント：** `POST /api/login_attempts/:session_id/verify`

**リクエスト：**
```json
{
  "verification_code": "123456"
}
```

**レスポンス（成功）：**
```json
{
  "success": true,
  "message": "ログイン成功"
}
```

**レスポンス（失敗）：**
```json
{
  "success": false,
  "error": "コードが正しくありません"
}
```

---

## 6. 技術スタック

### 6.1 フロントエンド

- **Vue.js 3.x** - UIフレームワーク
- **axios** - HTTP通信ライブラリ
- **CSS** - スタイリング

### 6.2 バックエンド

- **Rails 7.x** - Webフレームワーク
- **メモリ内データストレージ** - DB不要

### 6.3 データストレージ

- **グローバル変数** - `$users`, `$login_attempts`

---

## 7. 実装の特徴

### 7.1 学習効果

- 2要素認証の基本的な仕組みを理解できる
- パスワード認証と別要素認証の違いが理解できる
- ポーリングによるリアルタイム通信が学べる
- 状態管理（ステータス遷移）が学べる

### 7.2 シンプルさ

- データベース不要でセットアップが簡単
- ビジネスロジックに集中できる
- デバッグが簡単（メモリの内容を直接確認可能）

### 7.3 拡張性

- 将来的にDBに移行可能な設計
- メール送信機能の追加が容易
- SMS送信機能の追加が容易

---

## 8. テストユーザー情報

| ユーザー名 | パスワード |
|-----------|-----------|
| Taro | password123 |
| Hanako | password456 |

---

## 9. 有効期限設定

| 項目 | 時間 |
|-----|------|
| 検証コード有効期限 | 5分 |
| 確認POP-UP表示時間 | 5秒 |
| ポーリング間隔 | 1秒 |

---

## 10. エラーハンドリング

### 10.1 ログイン時のエラー

- ユーザーが見つからない
- パスワードが正しくない
- 入力が空である

### 10.2 認証デバイス側のエラー

- ログイン試行がない（ポーリング結果が空）
- ログイン試行が期限切れ

### 10.3 コード検証のエラー

- コードが正しくない
- コードが期限切れ
- ステータスが「approved」でない

---

## 11. セキュリティに関する注意

本アプリは**学習用**です。本番運用を想定していません。

学習を進める中で、以下の改善点に気づくことが期待されます：

- パスワードハッシュ化の必要性
- HTTPS通信の必要性
- CSRF対策
- レート制限（ブルートフォース対策）
- セッション管理
- 入力値のバリデーション

---

## 12. 今後の展開

このアプリをベースに、以下の機能を追加することで、さらに学習を深められます：

- **TOTP認証**への変更（Google Authenticatorなど）
- **バックアップコード**機能
- **デバイス登録**機能
- **ログイン履歴**表示
- **メール送信**機能
- **SMS送信**機能
- **データベース**への移行

---

**バージョン：1.0**  
**作成日：2025年10月25日**